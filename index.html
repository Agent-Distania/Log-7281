<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Underground</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ========== GENERAL STYLES ========== */
    body {
      background-color: #111;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }

    /* ========== CRT LOGIN SCREEN ========== */
    #crt-login {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      color: #0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 2s ease;
      overflow: hidden;
      animation: crtFlickerScreen 1.2s ease-in;
    }
    #crt-login.faded {
      opacity: 0 !important;
      pointer-events: none;
    }
    #crt-boot-text {
      font-size: 1.5em;
      text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
      margin-bottom: 20px;
      opacity: 0;
      animation: bootTextFlicker 3s forwards;
    }
    #power-button {
      font-size: 1.2em;
      background-color: black;
      border: 2px solid #0f0;
      padding: 10px 20px;
      color: #0f0;
      cursor: pointer;
      text-shadow: 0 0 5px #0f0, 0 0 15px #0f0;
    }
    #power-button:hover {
      background-color: #0f0;
      color: black;
      text-shadow: none;
    }
    @keyframes bootTextFlicker {
      0% { opacity: 0; } 10% { opacity: 1; } 20% { opacity: 0.2; }
      40% { opacity: 1; } 60% { opacity: 0.4; } 80% { opacity: 1; }
      100% { opacity: 1; }
    }
    @keyframes crtFlickerScreen {
      0% { opacity: 0; transform: scaleY(0.1); }
      20% { opacity: 1; transform: scaleY(1.2); }
      40% { transform: scaleY(0.9); }
      60% { transform: scaleY(1.05); }
      80% { transform: scaleY(0.98); }
      100% { opacity: 1; transform: scaleY(1); }
    }

    /* ========== ONLINE USERS DROPDOWN (TOP RIGHT) ========== */
    #online-users-container {
      position: absolute;
      top: 10px; right: 10px;
      background: black; border: 1px solid #0f0;
      padding: 4px 8px; z-index: 100;
    }

    /* ========== CHAT STYLES ========== */
    #chat-container {
      position: relative;
      max-width: 800px; margin: 20px auto;
      border: 1px solid #0f0; background: #000;
      overflow: hidden; font-size: 14px; line-height: 1.4em;
    }
    #chat-noise {
      position: absolute; inset: 0;
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAYAAjCB0C8AAAAASUVORK5CYII=') repeat;
      opacity: 0.04; pointer-events: none; z-index: 2;
      animation: noiseAnim 1s steps(10) infinite;
    }
    @keyframes noiseAnim {
      0%,100%{background-position:0 0;}50%{background-position:100% 100%;}
    }

    #chat-box {
      padding: 10px; max-height: 400px; overflow-y: auto;
      z-index: 3; color: #0f0; font-family: monospace;
      white-space: pre-wrap; word-wrap: break-word;
      scrollbar-width: thin; scrollbar-color: #0f0 transparent;
    }
    #chat-box::-webkit-scrollbar { width:8px; }
    #chat-box::-webkit-scrollbar-thumb {
      background-color: #0f0; border-radius:4px;
    }

    .message {
      margin-bottom:8px; padding:2px 4px;
      border-radius:3px; position:relative;
    }
    .message.highlighted-user {
      background-color: rgba(255,0,0,0.3);
      color: #f00; font-weight: bold;
    }

    .chat-image, .chat-video, .chat-audio {
      display:block; margin-top:2px; border:1px solid #0f0;
      border-radius:4px;
    }
    .chat-image { max-width:200px; max-height:150px; }
    .chat-video { max-width:300px; }
    .chat-audio { max-width:200px; }

    .edit-btn, .save-btn, .cancel-btn {
      background:transparent; border:1px solid #0f0; color:#0f0;
      cursor:pointer; font-size:0.8em; margin-left:6px;
      padding:1px 6px; border-radius:3px;
    }
    .edit-btn:hover, .save-btn:hover, .cancel-btn:hover {
      background: #0f0; color:black;
    }
    .edit-input {
      background:black; border:1px solid #0f0; color:#0f0;
      font-family:monospace; font-size:1em; padding:2px 4px;
      margin-left:6px; width:60%; border-radius:3px;
    }

    /* ========== MESSAGE INPUT FORM ========== */
    #chat-form {
      margin:10px auto; max-width:800px;
      display:flex; gap:8px;
    }
    #chat-form input[type="text"] {
      flex-grow:1; background:black; border:2px solid #0f0;
      color:#0f0; font-family:monospace; font-size:1em;
      padding:6px 10px; border-radius:4px;
      caret-color:#0f0; outline-offset:2px; outline-color:#0f0;
    }
    #chat-form input::placeholder { color:#0f0; opacity:0.6; }
    #chat-form button {
      background:black; border:2px solid #0f0; color:#0f0;
      font-family:monospace; font-size:1em;
      padding:6px 12px; border-radius:4px; cursor:pointer;
      transition:background-color 0.3s ease, color 0.3s ease;
    }
    #chat-form button:hover { background:#0f0; color:black; }

    /* ========== TYPING INDICATOR ========== */
    #typing-indicator {
      font-style:italic; margin-top:6px; color:#0f0;
      opacity:0.7; font-size:0.9em; font-family:monospace;
      animation:blinkTyping 1.4s infinite;
    }
    @keyframes blinkTyping {
      0%,100%{opacity:0.7;}50%{opacity:0.3;}
    }
  </style>
</head>
<body>
  <div id="crt-login">
    <div id="crt-boot-text">BOOTING SYSTEM...</div>
    <button id="power-button">[ ON ]</button>
  </div>

  <h1>The Underground</h1>
  <p id="user-count">Users online: 0</p>
  <button id="change-username">Change Username</button>

  <div id="channel-container">
    <label for="channel-select">Select Channel:</label>
    <select id="channel-select">
      <option value="general">#general</option>
      <option value="memes">#memes</option>
      <option value="gaming">#gaming</option>
      <option value="twitter">#twitter</option>
    </select>
  </div>

  <div id="online-users-container">
    Online Users:
    <select id="online-users-dropdown" size="1">
      <option value="">-- Select User --</option>
    </select>
  </div>

  <div id="chat-container">
    <div id="chat-bg"></div>
    <div id="chat-noise"></div>
    <div id="chat-box"></div>
    <div id="typing-indicator" style="display:none;">Someone is typing...</div>
  </div>

  <form id="chat-form">
    <input type="text" id="message" placeholder="Enter message" autocomplete="off" required />
    <button type="submit">Send</button>
    <input type="file" id="imageInput" accept="image/*,video/mp4,audio/mpeg" style="display: none;" />
    <button type="button" id="sendImage">Send Image</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, push,
      onChildAdded, onChildChanged, set,
      onValue, onDisconnect, update, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // --- Firebase init ---
    const firebaseConfig = {
      apiKey: "...", authDomain: "...",
      databaseURL: "...", projectId: "...",
      storageBucket: "...", messagingSenderId: "...",
      appId: "...", measurementId: "..."
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // --- UI elements ---
    const chatBox         = document.getElementById("chat-box");
    const chatForm        = document.getElementById("chat-form");
    const messageInput    = document.getElementById("message");
    const imageInput      = document.getElementById("imageInput");
    const sendImageBtn    = document.getElementById("sendImage");
    const userCount       = document.getElementById("user-count");
    const userDropdown    = document.getElementById("online-users-dropdown");
    const changeUsernameBtn = document.getElementById("change-username");
    const channelSelect   = document.getElementById("channel-select");
    const typingIndicator = document.getElementById("typing-indicator");
    const loginOverlay    = document.getElementById("crt-login");
    const powerButton     = document.getElementById("power-button");

    // --- State ---
    let username       = localStorage.getItem("username") || prompt("Enter your username:") || "Anonymous";
    let currentChannel = localStorage.getItem("channel") || "general";
    localStorage.setItem("username", username);
    channelSelect.value = currentChannel;
    localStorage.setItem("channel", currentChannel);

    // --- Sanitize function ---
    function sanitizeUsername(name) {
      return name.replace(/[.#$\[\]]/g, "_");
    }

    // --- Presence management ---
    let userRef = null;
    function setUserPresence(name) {
      if (userRef) remove(userRef).catch(console.warn);
      const safeName = sanitizeUsername(name);
      userRef = ref(db, `users/${safeName}`);
      onDisconnect(userRef).remove();
      set(userRef, { online: true, lastOnline: Date.now() });
    }
    setUserPresence(username);
    window.addEventListener("beforeunload", () => {
      if (userRef) remove(userRef);
    });
    changeUsernameBtn.addEventListener("click", () => {
      const newName = prompt("Enter new username:", username);
      if (newName && newName.trim() !== "" && newName !== username) {
        remove(userRef).catch(console.warn);
        username = newName.trim();
        localStorage.setItem("username", username);
        setUserPresence(username);
        highlightSelectedUserMessages();
      }
    });

    // --- Online users listener ---
    const usersRef = ref(db, "users");
    onValue(usersRef, snap => {
      const data = snap.val() || {};
      const list = Object.keys(data);
      userCount.textContent = `Users online: ${list.length}`;
      userDropdown.innerHTML = '<option value="">-- Select User --</option>';
      list.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u; opt.textContent = u;
        userDropdown.appendChild(opt);
      });
    });

    // --- Message handling ---
    function getMessagesRef(ch) { return ref(db, `channels/${ch}/messages`); }
    let msgRef = getMessagesRef(currentChannel);

    function formatTimestamp(ts) {
      const d = new Date(ts);
      const h = d.getHours(), m = String(d.getMinutes()).padStart(2,"0");
      return `${(h%12||12)}:${m} ${h>=12?"PM":"AM"}`;
    }
    function createMessageElement(key,val) {
      const div = document.createElement("div");
      div.className = "message"; div.dataset.id = key;
      div.dataset.user = val.username;
      const content = val.media
        ? (val.mediaType.startsWith("image/") 
            ? `<img src="${val.media}" class="chat-image"/>`
            : val.mediaType==="video/mp4"
              ? `<video controls class="chat-video"><source src="${val.media}"/></video>`
              : `<audio controls class="chat-audio"><source src="${val.media}"/></audio>`)
        : val.message;
      div.innerHTML = `[${formatTimestamp(val.timestamp)}] <strong>${val.username}:</strong> <span class="msg-content">${content}</span>`;
      if(val.username===username && !val.media) {
        const btn = document.createElement("button");
        btn.className="edit-btn"; btn.textContent="Edit";
        btn.onclick = ()=>enterEditMode(div,key,val);
        div.appendChild(btn);
      }
      if(selectedUser===val.username) div.classList.add("highlighted-user");
      return div;
    }
    function subscribeMessages(ch) {
      msgRef = getMessagesRef(ch);
      onChildAdded(msgRef, s => {
        chatBox.appendChild(createMessageElement(s.key,s.val()));
        maybeScrollToBottom();
      });
      onChildChanged(msgRef, s => {
        const existing = chatBox.querySelector(`[data-id="${s.key}"]`);
        if(existing) {
          const newEl = createMessageElement(s.key,s.val());
          chatBox.replaceChild(newEl,existing);
        }
      });
    }
    function unsubscribeMessages() {
      chatBox.innerHTML="";
    }
    subscribeMessages(currentChannel);
    channelSelect.addEventListener("change", ()=>{
      currentChannel = channelSelect.value;
      localStorage.setItem("channel",currentChannel);
      unsubscribeMessages();
      subscribeMessages(currentChannel);
    });

    // --- Typing indicator ---
    function sendTyping() {
      set(ref(db,`typing/${currentChannel}/${username}`),true);
      clearTimeout(window._typingTO);
      window._typingTO = setTimeout(()=>remove(ref(db,`typing/${currentChannel}/${username}`)),1500);
    }
    messageInput.addEventListener("input", sendTyping);
    onValue(ref(db,`typing/${currentChannel}`),s=>{
      const t = s.val()||{};
      const others = Object.keys(t).filter(u=>u!==username);
      typingIndicator.style.display = others.length? "block":"none";
    });

    // --- Highlight user messages ---
    let selectedUser = null;
    userDropdown.addEventListener("change", ()=>{
      selectedUser = userDropdown.value||null;
      document.querySelectorAll(".message").forEach(m=>{
        m.classList.toggle("highlighted-user", m.dataset.user===selectedUser);
      });
    });

    function maybeScrollToBottom(){
      if(chatBox.scrollTop+chatBox.clientHeight >= chatBox.scrollHeight-50){
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    // --- Sending ---
    chatForm.addEventListener("submit",async e=>{
      e.preventDefault();
      const txt = messageInput.value.trim(); if(!txt) return;
      await push(getMessagesRef(currentChannel),{ username, message: txt, timestamp: Date.now() });
      messageInput.value="";
      remove(ref(db,`typing/${currentChannel}/${username}`));
    });
    sendImageBtn.onclick = ()=>imageInput.click();
    imageInput.onchange = ()=>{
      const f = imageInput.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = async e=>{
        await push(getMessagesRef(currentChannel),{
          username, media: e.target.result, mediaType: f.type, timestamp: Date.now()
        });
      };
      r.readAsDataURL(f);
      imageInput.value="";
    };

    // --- Simple editing and reactions omitted for brevity ---

    // --- CRT power button ---
    powerButton.onclick = ()=>{
      loginOverlay.classList.add("faded");
      setTimeout(()=> loginOverlay.style.display="none",2000);
    };
  </script>
</body>
</html>
